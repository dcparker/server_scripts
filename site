#!/usr/bin/env ruby

require 'ftools'
require 'yaml'

$user = ENV['SUDO_USER'] || ENV['USER']

unless File.directory?("#{ENV['HOME']}/SiteConfigs")
  File.makedirs("#{ENV['HOME']}/SiteConfigs")
  system("chown #{$user}:#{$user} #{ENV['HOME']}/SiteConfigs")
end
Dir.chdir("#{ENV['HOME']}/SiteConfigs")

if File.exists?("#{ENV['HOME']}/SiteConfigs/.port_range")
  $port_range = File.read("#{ENV['HOME']}/SiteConfigs/.port_range").gsub(/\D/,'').to_i
else
  puts "Please echo '####' > ~/SiteConfigs/.port_range, #### being the beginning port number, in the thousands, that you will be using. Port numbers used will be assigned starting at ##10, adding 10 for each subsequent site generated by this command. Yes, I manage it myself."
  exit
end

def interpolate(fulltext, replace={})
  replace.each do |key,value|
    fulltext.gsub!(/\[#{key.to_s}\]/, value.to_s)
  end
  fulltext
end

require 'optparse'
options = {}
optparse = OptionParser.new do |opts|
  opts.banner = "Usage: site (new|activate|deactivate) domain.com"

  # options[:verbose] = false
  # opts.on( '-v', '--verbose', "Show me what you're doing" ) do
  #   options[:verbose] = true
  # end

  options[:thin] = false
  opts.on( '-t', '--thin', "Will set up thin configs as well" ) do
    options[:thin] = true
  end

end

action = ARGV[0]
domain = ARGV[1]
fail "Usage: site (new|activate|deactivate) domain.com" if ARGV.length < 2 && action != 'list'
home   = ENV['HOME']

matches = Dir.glob("*-#{domain}")
file_domain = matches[0] if matches.length > 0

case ARGV[0]
when 'new'
  # 1) Gather some data
  iterator = if File.exists?('.site_iterator')
    File.read('.site_iterator').gsub(/\D/,'').to_i
  else
    0
  end + 1
  File.open('.site_iterator', 'w') do |file|
    file << iterator
  end
  ports = [$port_range + iterator*10]
  ports[1] = ports[0]+1
  ports[2] = ports[1]+1
  ports[3] = ports[2]+1
  ports[4] = ports[3]+1

  # 2) Copy the samples
  File.open("#{iterator}-#{domain}", 'w') do |file|
    file << interpolate(File.read('/etc/sites/sample-site.com'), {
      :SITE => domain,
      :PORT => ports[0],
      :HOME => home
    })
  end
  system("chown #{$user}:#{$user} #{ENV['HOME']}/SiteConfigs/#{iterator}-#{domain}")
  File.open("#{iterator}-#{domain}-thin.yml", 'w') do |file|
    file << interpolate(File.read('/etc/sites/sample-site.com-thin.yml'), {
      :SITE => domain,
      :PORT1 => ports[1],
      :HOME => home
    })
  end if options[:thin]
  system("chown #{$user}:#{$user} #{ENV['HOME']}/SiteConfigs/#{iterator}-#{domain}-thin.yml") if options[:thin]
  File.open("#{iterator}-#{domain}.cfg", 'w') do |file|
    file << interpolate(File.read('/etc/sites/sample-site.com.cfg'), {
      :SITE_NAME => domain.gsub(/[\.]/,'_'),
      :PORT => ports[0],
      :PORT1 => ports[1],
      :PORT2 => ports[2],
      :PORT3 => ports[3],
      :PORT4 => ports[4]
    })
  end
  system("chown #{$user}:#{$user} #{ENV['HOME']}/SiteConfigs/#{iterator}-#{domain}.cfg")
  puts "Site #{domain} configs created and ready to activate."
when 'remove'
  if File.exists?("/etc/nginx/sites-enabled/#{domain}") || File.exists?("/etc/nginx/sites-available/#{domain}") || File.exists?("/etc/haproxy/sites/#{domain}.cfg") || File.exists?("/etc/thin/#{domain}-thin.yml")
    puts "Can't remove #{domain} yet: Must deactivate first!"
  else
    system("rm #{home}/SiteConfigs/#{file_domain}*")
    puts "Site #{domain} removed."
  end
when 'activate'
  if File.exists?("/etc/nginx/sites-enabled/#{domain}") || File.exists?("/etc/nginx/sites-available/#{domain}") || File.exists?("/etc/haproxy/sites/#{domain}.cfg") || File.exists?("/etc/thin/#{domain}-thin.yml")
  else
    # 1) hardlink it into /etc/nginx/sites-available
    system("ln #{home}/SiteConfigs/#{file_domain} /etc/nginx/sites-available/#{domain}")
    # 2) symlink it into /etc/nginx/sites-enabled
    system("ln -s /etc/nginx/sites-available/#{domain} /etc/nginx/sites-enabled/#{domain}")
    # 3) hardlink thin config into /etc/thin
    system("ln #{home}/SiteConfigs/#{file_domain}-thin.yml /etc/thin/#{domain}-thin.yml") if File.exists?("#{home}/SiteConfigs/#{file_domain}-thin.yml")
    # 4) hardlink it into /etc/haproxy/sites
    system("ln #{home}/SiteConfigs/#{file_domain}.cfg /etc/haproxy/sites/#{domain}.cfg")
    if File.exists?("#{home}/apps/#{domain}/config/cilantro.yml")
      iterator = file_domain.match(/^(\d+)/)[1].to_i
      ports = []
      ports[0] = $port_range + 1 + iterator*10
      ports[1] = ports[0]+1
      ports[2] = ports[1]+1
      ports[3] = ports[2]+1
      config = YAML.load_file(options[:config] || "#{home}/apps/#{domain}/config/cilantro.yml")
      config[:ports] = ports
      File.open("#{home}/apps/#{domain}/config/cilantro.yml", 'w') do |cilantro|
        cilantro << config.to_yaml
      end
    end
  end
  # 5) Reload haproxy
  system("/etc/init.d/haproxy reload")
  # 6) Reload nginx
  system("/etc/init.d/nginx reload")
  # 7) Start services that run this app
    # Cilantro
    system("cilantro start #{home}/apps/#{domain}") if File.exists?("#{home}/apps/#{domain}/config/cilantro.yml")
    # Thin
    system("thin start --config /etc/thin/#{domain}-thin.yml") if File.exists?("#{home}/SiteConfigs/#{file_domain}-thin.yml")
when 'deactivate'
  # 1) remove all of the configs from the active system
  system("rm /etc/nginx/sites-enabled/#{domain}") if File.exists?("/etc/nginx/sites-enabled/#{domain}")
  system("rm /etc/nginx/sites-available/#{domain}") if File.exists?("/etc/nginx/sites-available/#{domain}")
  system("rm /etc/thin/#{domain}-thin.yml") if File.exists?("/etc/thin/#{domain}-thin.yml")
  system("rm /etc/haproxy/sites/#{domain}.cfg") if File.exists?("/etc/haproxy/sites/#{domain}.cfg")

  # 2) Reload nginx
  system("/etc/init.d/nginx reload")
  # 3) Reload haproxy
  system("/etc/init.d/haproxy reload")
  # 4) Stop any services running this app
    # Cilantro
    system("cilantro stop #{home}/apps/#{domain}") if File.exists?("#{home}/apps/#{domain}/config/cilantro.yml")
    # Thin
    system("thin stop --config /etc/thin/#{domain}-thin.yml") if File.exists?("#{home}/SiteConfigs/#{file_domain}-thin.yml")
when 'list'
  matches = Dir.glob("*.cfg").select {|ha| ha =~ /^\d+-/}.collect {|ha| ha.match(/^\d+-(.+)\.cfg$/)[1]}
  puts "Managed Sites:\n\t#{matches.join("\n\t")}"
when 'restart'
  # Cilantro
  system("cilantro stop #{home}/apps/#{domain}") if File.exists?("#{home}/apps/#{domain}/config/cilantro.yml")
  system("cilantro start #{home}/apps/#{domain}") if File.exists?("#{home}/apps/#{domain}/config/cilantro.yml")
  # Thin
  system("thin stop --config /etc/thin/#{domain}-thin.yml") if File.exists?("#{home}/SiteConfigs/#{file_domain}-thin.yml")
  system("thin start --config /etc/thin/#{domain}-thin.yml") if File.exists?("#{home}/SiteConfigs/#{file_domain}-thin.yml")
end
